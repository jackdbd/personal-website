name: 'Ask HN Freelancer? Seeking Freelancer? (by whoishiring)'

on:
  schedule:
    # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule
    # https://crontab.guru/
    - cron:  '45 15 5 * *'
  workflow_dispatch:
    # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch
    # You can trigger this workflow manually using the GitHub CLI:
    # gh workflow run "Ask HN Freelancer? Seeking Freelancer? (by whoishiring)" --ref branch-name

jobs:
  ask-hn-to-telegram:
    name: Post on Ask HN Freelancer? Seeking Freelancer?
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        node: ['current']
    steps:
      - name: üõéÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: üñ•Ô∏è Setup Node.js ${{ matrix.node }}
        # https://github.com/marketplace/actions/setup-node-js-environment
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}

      - name: Setup Steampipe and its plugins
        # https://github.com/marketplace/actions/setup-steampipe
        uses: francois2metz/setup-steampipe@v1
        with:
          steampipe-version: 'latest'
          steampipe-plugins: |
            {
              "hackernews": {}
            }

      - name: Query Hacker News
        run: |
          delimiter=$(openssl rand -hex 8)
          echo "HN_JSON<<$delimiter" >> $GITHUB_ENV
          node scripts/hacker-news/whoishiring-item-id >> $GITHUB_ENV
          echo "$delimiter" >> $GITHUB_ENV

      - name: üí¨ Notify Telegram
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ fromJSON(secrets.TELEGRAM).chat_id }}
          token: ${{ fromJSON(secrets.TELEGRAM).token }}
          format: html
          disable_web_page_preview: true
          message: |
            <b>ü§ñ Ask HN Freelancer reminder</b>

            <a href="https://news.ycombinator.com/item?id=${{ fromJSON(env.HN_JSON).item_id }}">${{ fromJSON(env.HN_JSON).title }}</a>

            <i>Posted by ${{ fromJSON(env.HN_JSON).username }} in ${{ fromJSON(env.HN_JSON).date }}</i>

      - name: Read ad for Ask HN Freelancer
        run: |
          delimiter=$(openssl rand -hex 8)
          echo "HN_AD<<$delimiter" >> $GITHUB_ENV
          cat assets/ads/ask-hn-freelancer.txt >> $GITHUB_ENV
          echo "$delimiter" >> $GITHUB_ENV

      # Playwright complains if project dependencies are not installed
      - run: npm ci

      - name: Install Playwright and all browsers
        # https://github.com/microsoft/playwright-github-action#playwright-cli-with-github-actions-ci
        run: npx playwright install --with-deps

      # TODO: run playwright script to post the ad to HN
      # https://github.com/microsoft/playwright-github-action#-use-the-playwright-cli
      - name: Post my ad on HN using Playwright
        env:
          HACKER_NEWS: ${{ secrets.HACKER_NEWS }}
        run: |
          delimiter=$(openssl rand -hex 8)
          echo "RESULT_STRING<<$delimiter" >> $GITHUB_ENV
          node scripts/hacker-news/post-ad-on-ask-hn-seeking-freelancer.cjs ${{ fromJSON(env.HN_JSON).item_id }} >> $GITHUB_ENV
          echo "$delimiter" >> $GITHUB_ENV

      - name: üí¨ Notify Telegram of my ad
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ fromJSON(secrets.TELEGRAM).chat_id }}
          token: ${{ fromJSON(secrets.TELEGRAM).token }}
          format: html
          disable_web_page_preview: true
          message: |
            <b>ü§ñ Ask HN Freelancer ad posting result</b>

            <pre>${{ env.RESULT_STRING }}</pre>
